<% provide(:title, @user.full_name) %>

<% if current_user.is_admin? %>
    <ol class="breadcrumb">
      <li><%= link_to 'Users', users_path %></li>
      <li class="active"><%= @user.username %></li>
    </ol>
<% end %>

<div class="row">
  <div class="col-sm-8">
    <h1 id="show_user">
      <%= gravatar_for @user %>
      <%= @user.full_name %>
      <small><%= @user.username %></small>
    </h1>
  </div>
  <div class="col-sm-4" style="text-align:right">
    <div class="btn-group">
      <!-- Enable/Disable -->
      <% if current_user.is_admin? %>
          <% if @user.enabled %>
              <%= link_to disable_user_path(@user), method: :patch,
                          class: 'btn btn-default' do %>
                  <%= content_tag(:span, '', class: 'glyphicon glyphicon-remove') %>
                  Disable
              <% end %>
          <% else %>
              <%= link_to enable_user_path(@user), method: :patch,
                          class: 'btn btn-default' do %>
                  <%= content_tag(:span, '', class: 'glyphicon glyphicon-ok') %>
                  Enable
              <% end %>
          <% end %>
      <% end %>
      <!-- Edit -->
      <% if current_user.is_admin? || current_user == @user %>
          <%= link_to edit_user_path(@user), class: 'btn btn-default' do %>
              <%= content_tag(:span, '', class: 'glyphicon glyphicon-pencil') %>
              Edit
          <% end %>
      <% end %>
      <!-- Delete -->
      <% if current_user.is_admin? && current_user != @user %>
          <%= link_to user_path(@user), method: 'delete',
                      class: 'btn btn-default',
                      data: { confirm: 'Deleting this user will break all '\
                          'associations between the user and any related '\
                          'institutions, locations, or assessments. It is '\
                          'recommended that inactive users be disabled, not '\
                          'deleted. Are you sure you want to delete this '\
                          'user?' } do %>
              <%= content_tag(:span, '', class: 'glyphicon glyphicon-trash') %>
              Delete
          <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="row">

  <div class="col-sm-4">
    <dl>
      <dt>Institution</dt>
      <dd><%= @user.institution ? @user.institution.name : 'Unaffiliated' %></dd>
      <dt>Email</dt>
      <dd><a href="mailto:<%= @user.email %>"><%= @user.email %></a></dd>
      <dt>Account</dt>
      <dd>
        <%= @user.confirmed ? 'Confirmed' : 'Not Confirmed' %>,
        <%= @user.enabled ? 'Enabled' : 'Disabled' %>
      </dd>
      <dt>Account Created</dt>
      <dd><%= local_time_ago(@user.created_at) %></dd>
      <dt>Last Sign-In</dt>
      <dd>
        <% if @user.last_signin %>
            <%= local_time_ago(@user.last_signin) %>
        <% else %>
            Never
        <% end %>
      </dd>
    </dl>
  </div>

  <div class="col-sm-8">

    <ul class="nav nav-tabs">
      <li class="active">
        <a href="#assessments" data-toggle="tab">Assessments</a>
      </li>
    </ul>

    <div class="tab-content">
      <div id="assessments" class="tab-pane active">
        <% # This view unfortunately can't use the resources/resources partial
           # because it displays resources hierarchically, which is problematic
           # when the user doesn't own the entire hierarchy. So we will display
           # all of the user's resources in a flat list. %>
        <% if @resources.any? %>
            <table class="table table-striped">
              <thead>
              <tr>
                <th></th>
                <th>Title</th>
                <th>Type</th>
                <th>Complete</th>
              </tr>
              </thead>
              <tbody>
              <% @resources.each do |resource| %>
                  <tr>
                    <td>
                      <%= link_to 'Edit', edit_resource_path(resource) %>
                    </td>
                    <td><%= link_to resource.name, resource %></td>
                    <td><%= resource.readable_resource_type %></td>
                    <td><%= number_to_human resource.assessment_percent_complete * 100 %>%</td>
                  </tr>
              <% end %>
              </tbody>
            </table>
        <% else %>
            <% if @user == current_user %>
                <p>You have not begun any assessments.</p>
            <% else %>
                <p>This user has not begun any assessments.</p>
            <% end %>
        <% end %>
      </div>

    </div>

  </div>

</div>
