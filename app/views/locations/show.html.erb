<% provide(:title, @location.name) %>
<% provide(:body_id, 'show_location') %>

<% breadcrumbs = []
   breadcrumbs << { 'Institutions' => institutions_path } if current_user.is_admin?
   breadcrumbs << { @location.repository.institution.name =>
                            @location.repository.institution }
   breadcrumbs << { @location.repository.name => @location.repository }
   breadcrumbs << @location.name
%>
<%= breadcrumbs(breadcrumbs) %>

<div class="row">
  <div class="col-sm-6">
    <h1><%= @location.name %>
      <small><%= entity_icon(@location) %>Location</small>
    </h1>
  </div>
  <div class="col-sm-6">
    <div class="btn-group" style="float:right">
      <!-- Import button -->
      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          <span class="glyphicon glyphicon-import"></span> Import
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to 'From ArchivesSpace', '',
                          'data-toggle' => 'modal', 'data-target' => '#importModal' %></li>
        </ul>
      </div>
      <!-- Edit -->
      <%= link_to edit_location_path(@location), class: 'btn btn-default' do %>
        <%= content_tag(:span, '', class: 'glyphicon glyphicon-pencil') %>
        Edit
      <% end %>
      <!-- Assess -->
      <%= link_to location_assess_path(@location), class: 'btn btn-default' do %>
          <%= content_tag(:span, '', class: 'glyphicon glyphicon-stats') %>
          Assess
      <% end %>
      <!-- Delete -->
      <%= link_to location_path(@location), method: 'delete',
                  class: 'btn btn-danger',
                  data: { confirm: 'Deleting this location will also delete '\
                  'all resources it contains. Are you sure you want to '\
                  'delete this location?' } do %>
        <%= content_tag(:span, '', class: 'glyphicon glyphicon-trash') %>
        Delete
      <% end %>
    </div>
  </div>
</div>

<div class="row">

  <div class="col-sm-4">
    <ol class="psap-hierarchy-list">
      <li>
        <%= entity_icon(@location.repository) %>
        <%= link_to @location.repository.name, @location.repository %>
        <ol class="psap-hierarchy-list">
          <% @location.repository.locations.each do |loc| %>
            <li>
              <%= entity_icon loc %>
              <% if loc == @location %>
                <span class="active"><%= loc.name %></span>
              <% else %>
                <%= link_to loc.name, loc %>
              <% end %>
            </li>
          <% end %>
        </ol>
      </li>
    </ol>
  </div>

  <div class="col-sm-8">

    <ul class="nav nav-tabs">
      <li role="presentation" class="active">
        <a href="#resources_tab" data-toggle="tab">Resources</a>
      </li>
      <li role="presentation"><a href="#assessment_tab" data-toggle="tab">Assessment</a></li>
      <li role="presentation"><a href="#info_tab" data-toggle="tab">Info</a></li>
      <li role="presentation"><a href="#activity_tab" data-toggle="tab">Activity</a></li>
    </ul>

    <div class="tab-content">

      <div class="tab-pane active" id="resources_tab">
        <!-- Check/Uncheck All button -->
        <div class="btn-group">
          <button type="button" class="btn btn-default btn-sm psap-check-all">
            Check All
          </button>
          <button type="button" class="btn btn-default btn-sm psap-uncheck-all">
            Uncheck All
          </button>
        </div>

        <!-- Move Checked button -->
        <div class="btn-group" style="float:right">
          <button type="button" class="btn btn-default psap-move-checked"
                  data-toggle="modal" data-target="#moveModal"
                  <%= @resources.any? ? '' : 'disabled' %>>
            <i class="fa fa-share"></i> Move Checked
          </button>
          <%= button_link('Add Resource', new_location_resource_path(@location),
                          entity_icon(Resource), { class: 'btn-success' }) %>
        </div>

        <%= form_tag(resource_move_path) do %>
          <% if @resources.any? %>
            <div id="resources">
              <%= render partial: 'resources/resources',
                         locals: { resources: @resources,
                                   show_checkboxes: true,
                                   show_hierarchy: true } %>
            </div>
          <% else %>
            <p>There are no resources in this location.</p>
          <% end %>

          <!-- Move Checked modal -->
          <div class="modal fade" id="moveModal" tabindex="-1" role="dialog"
               aria-labelledby="moveModalLabel" aria-hidden="true" data-backdrop="false">
            <div class="modal-dialog">
              <div class="modal-content">

                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                  <h4 class="modal-title" id="moveModalLabel">Move Resources</h4>
                </div>
                <div class="modal-body">
                  <p>Select a location to move the checked resources into. If any
                    collections are checked, any resources they contain will be
                    moved along with them, even if they are not checked.</p>
                  <ul>
                    <% @location.repository.institution.repositories.order(:name).each do |repo| %>
                      <% if repo.locations.any? %>
                        <li><%= repo.name %>
                          <% repo.locations.where('id != ?', @location.id).order(:name).each do |loc| %>
                            <ul>
                              <li><label><input type="radio" name="location_id" value="<%= loc.id %>">
                                <%= loc.name %></label></li>
                            </ul>
                          <% end %>
                        </li>
                      <% end %>
                    <% end %>
                  </ul>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <input type="submit" class="btn btn-primary" value="Move Resources">
                </div>
              </div>
            </div>
          </div>

        <% end %>
      </div>

      <div class="tab-pane assessment" id="assessment_tab">

        <div class="psap-progress-container">
          Score: <%= number_to_human(@location.assessment_score * 100) %>
          <div class="progress">
            <div class="progress-bar <%= bootstrap_progress_bar_class_for_score(@location.assessment_score) %> score"
                 role="progressbar"
                 aria-valuenow="<%= @location.assessment_score * 100 %>"
                 aria-valuemin="0" aria-valuemax="100"
                 style="width:<%= @location.assessment_score * 100 %>%;">
            </div>
          </div>
        </div>

        <% @assessment_sections.each do |section| %>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title"><%= section.name %></h4>
            </div>

            <div class="panel-body">
              <%= render partial: 'shared/assessment_questions', locals: {
                      entity: @location,
                      assessment_questions: section.assessment_questions.where(parent_id: nil),
                      depth: 0 } %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="tab-pane" id="info_tab">
        <dl>
          <% if @location.description %>
            <dt>Description</dt>
            <dd><%= @location.description %></dd>
          <% end %>
        </dl>
      </div>

      <div class="tab-pane" id="activity_tab">
        <%= render 'shared/events', events: @events %>
      </div>

    </div> <!-- .tab-content -->

  </div> <!-- .col-sm-8 -->

</div> <!-- .row -->

<%= render partial: 'resources/import_from_archivesspace',
           locals: { form_action: location_resource_import_post_path(@location) } %>
