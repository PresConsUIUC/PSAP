<% provide(:title, @resource.name) %>
<% provide(:body_id, 'show_resource') %>

<ol class="breadcrumb">
  <% if current_user.is_admin? %>
      <li><%= link_to 'Institutions', institutions_path %></li>
  <% end %>
  <li>
    <%= link_to @resource.location.repository.institution.name,
                polymorphic_path(@resource.location.repository.institution) %>
  </li>
  <li>
    <%= link_to @resource.location.repository.name,
                polymorphic_path(@resource.location.repository) %>
  </li>
  <li>
    <%= link_to @resource.location.name,
                polymorphic_path(@resource.location) %>
  </li>
  <li class="active"><%= @resource.name %></li>
</ol>

<div class="row">
  <div class="col-sm-8">
    <h1><%= @resource.name %> <small><%= @resource.readable_resource_type %> Resource</small></h1>
  </div>
  <div class="col-sm-4">
    <div class="btn-group" style="float:right">
      <!-- Export -->
      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          <span class="glyphicon glyphicon-save"></span> Export
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to 'EAD', resource_path(@resource) + '.ead',
                          class: 'export', data: { filename: @resource.ead_filename } %></li>
          <li><%= link_to 'Dublin Core XML', resource_path(@resource) + '.dcxml',
                          class: 'export', data: { filename: @resource.dcxml_filename } %></li>
        </ul>
      </div>

      <!-- Assess -->
      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          <span class="glyphicon glyphicon-pencil"></span> Assess
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to 'This Resource',
                          edit_resource_path(@resource) %></li>
          <li><%= link_to 'New Sub-Resource',
                          new_resource_resource_path(@resource) %></li>
        </ul>
      </div>

      <!-- Delete -->
      <%= link_to resource_path(@resource), method: 'delete',
                  class: 'btn btn-default',
                  data: { confirm: 'Are you sure you want to delete this '\
                          'resource assessment?' } do %>
          <%= content_tag(:span, '', class: 'glyphicon glyphicon-trash') %>
          Delete
      <% end %>
    </div>
  </div>
</div>

<!-- Export notification modal panel -->
<div id="export_notification" class="modal fade"
     tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true" data-backdrop="false">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">
          Exporting <span class="format"></span>&hellip;</h4>
      </div>
      <div class="modal-body">
          <p>Check your downloads folder for a file named
            <strong id="filename"></strong>.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs">
  <% if @resource.children.any? %>
    <li class="active">
      <a href="#sub_resources" data-toggle="tab">Sub-Resources</a>
    </li>
  <% end %>
  <li <%= @resource.children.any? ? '' : 'class=active' %>>
    <a href="#assessment_tab" data-toggle="tab">Assessment</a>
  </li>
  <li><a href="#activity_tab" data-toggle="tab">Activity</a></li>
</ul>

<div class="tab-content">

  <% if @resource.children.any? %>
    <div id="sub_resources" class="tab-pane active">
      <%= render partial: 'resources/resources', locals: {
              resources: @resource.children.paginate(page: 1, per_page: 9999999) } %>
    </div>
  <% end %>

  <div id="assessment_tab" class="assessment tab-pane <%= @resource.children.any? ? '' : 'active' %>">

    <div class="row">
      <div class="col-sm-8">
        <%= @resource.assessment_question_responses.select{ |r| r.assessment_question_option_id }.length %> of
          <%= Assessment.find_by_key('resource').question_count %> questions complete
      </div>
      <div class="col-sm-4" style="text-align:center">
          Score: <%= number_to_human(@resource.assessment_score * 100) %>
        <div class="progress">
          <div class="progress-bar progress-bar-success score" role="progressbar"
               aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
               style="width:<%= @resource.assessment_score * 100 %>%;">
          </div>
        </div>
      </div>
    </div>

    <div class="panel-group assessment" id="section-general">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#section-general" href="#general">
              General
            </a>
          </h4>
        </div>
        <div id="general" class="panel-collapse collapse in">
          <div class="panel-body">
            <div class="col-sm-4">
              <dl>
                <% if @resource.parent %>
                  <dt>Parent Collection</dt>
                  <dd><%= link_to @resource.parent.name, @resource.parent %></dd>
                <% end %>
                <dt>Local Identifier</dt>
                <dd><%= @resource.local_identifier ? @resource.local_identifier : '(None)' %></dd>
                <% if @resource.creators.any? %>
                  <dt><%= @resource.creators.length == 1 ? 'Creator' : 'Creators' %></dt>
                  <dd>
                    <% if @resource.creators.length == 1 %>
                      <%= @resource.creators.first.name %>
                    <% else %>
                      <ul>
                        <% for creator in @resource.creators %>
                          <li><%= creator.name %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </dd>
                <% end %>
                <% if @resource.format %>
                  <dt>Format</dt>
                  <dd>
                    <% if current_user.is_admin? %>
                      <%= link_to @resource.format.name, @resource.format %>
                    <% else %>
                      <%= @resource.format.name %>
                    <% end %>
                  </dd>
                <% end %>
                <dt>Description</dt>
                <dd><%= @resource.description ? @resource.description : '(None)' %></dd>
              </dl>
            </div>
            <div class="col-sm-4">
              <dl>
                <% if @resource.resource_notes.any? %>
                  <dt>Notes</dt>
                  <dd>
                    <% if @resource.resource_notes.length == 1 %>
                      <%= @resource.resource_notes[0].value %>
                    <% else %>
                      <ul>
                        <% @resource.resource_notes.each do |note| %>
                          <li><%= note.value %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </dd>
                <% end %>
                <% if @resource.resource_dates.any? %>
                  <dt><%= @resource.resource_dates.length == 1 ? 'Date' : 'Dates' %></dt>
                  <dd>
                    <% if @resource.resource_dates.length == 1 %>
                      <%= human_readable_date(@resource.resource_dates[0]) %>
                    <% else %>
                      <ul>
                        <% for date in @resource.resource_dates %>
                          <li><%= human_readable_date(date) %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </dd>
                <% end %>
                <% if @resource.subjects.any? %>
                  <dt><%= @resource.subjects.length == 1 ? 'Subject' : 'Subjects' %></dt>
                  <dd>
                    <% if @resource.subjects.length == 1 %>
                      <%= @resource.subjects.first.name %>
                    <% else %>
                      <ul>
                        <% for subject in @resource.subjects %>
                          <li><%= subject.name %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </dd>
                <% end %>
                <% if @resource.extents.any? %>
                  <dt><%= @resource.extents.length == 1 ? 'Extent' : 'Extents' %></dt>
                  <dd>
                    <% if @resource.extents.length == 1 %>
                      <%= @resource.extents.first.name %>
                    <% else %>
                      <ul>
                        <% for extent in @resource.extents %>
                          <li><%= extent.name %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </dd>
                <% end %>
              </dl>
            </div>
            <div class="col-sm-4">
              <dl>
                <% if @resource.rights %>
                  <dt>Rights</dt>
                  <dd><%= @resource.rights %></dd>
                <% end %>
                <dt>Created</dt>
                <dd><%= local_time_ago(@resource.created_at) %> by
                  <%= link_to @resource.user.full_name, @resource.user %></dd>
                <dt>Last Updated</dt>
                <dd><%= local_time_ago(@resource.updated_at) %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <% i = 0; @assessment_sections.each do |section| # TODO: sub-questions %>
        <div class="panel panel-default">
          <div class="panel-heading">
              <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#accordion" href="#section-<%= section.id %>">
                      <%= section.name %>
                      <small>(<%= @resource.assessment_question_responses.
                                          where('assessment_question_id IN (?) AND assessment_question_option_id IS NOT NULL',
                                                section.assessment_questions.map{ |q| q.id }).
                                          length %> of <%= section.assessment_questions.length %> complete)</small>
                  </a>
              </h4>
          </div>
          <div id="section-<%= section.id %>" class="panel-collapse collapse">
            <div class="panel-body">
              <% section.assessment_questions.order(:index).each do |question| %>
                <dt><%= question.name %></dt>

                <% response = @resource.assessment_question_responses.where(assessment_question_id: question.id).first %>

                <dd>
                  <ul>
                    <% question.assessment_question_options.order(:index).each do |option| %>
                      <li <%= response && response.assessment_question_option &&
                                      option.id == response.assessment_question_option.id ? 'class=selected' : '' %>>
                        <%= option.name %>
                      </li>
                    <% end %>
                  </ul>
                </dd>
              <% end %>
            </div>
          </div>
        </div>
      <% i += 1; end %>
    </div>
  </div>

  <div id="activity_tab" class="tab-pane">
    <%= render 'shared/events', events: @events %>
  </div>
</div> <!-- .tab-content -->
